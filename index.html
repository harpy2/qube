<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUBE â€” ë°©íƒˆì¶œ ë¯¸ìŠ¤í„°ë¦¬</title>
<meta name="description" content="í’€ì–´ë¼. íƒˆì¶œí•˜ë¼. ë§¤ì¼ ìƒˆë¡œìš´ ë¯¸ìŠ¤í„°ë¦¬ ë°©íƒˆì¶œ ê²Œì„.">
<meta property="og:title" content="QUBE â€” ë°©íƒˆì¶œ ë¯¸ìŠ¤í„°ë¦¬">
<meta property="og:description" content="í’€ì–´ë¼. íƒˆì¶œí•˜ë¼. ë§¤ì¼ ìƒˆë¡œìš´ ë¯¸ìŠ¤í„°ë¦¬ ë°©íƒˆì¶œ ê²Œì„.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --bg2: #12121a;
  --bg3: #1a1a28;
  --text: #e8e8f0;
  --text2: #8888aa;
  --accent: #7c3aed;
  --accent2: #06b6d4;
  --accent-glow: rgba(124,58,237,0.3);
  --success: #22c55e;
  --danger: #ef4444;
  --warn: #f59e0b;
  --card: #16162a;
  --border: #2a2a40;
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
.hidden { display: none !important; }

/* â”€â”€â”€ ê³µí†µ â”€â”€â”€ */
.container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
button {
  font-family: inherit; cursor: pointer;
  border: none; outline: none; transition: all .2s;
}
.btn-primary {
  background: var(--accent);
  color: #fff; padding: 14px 32px;
  border-radius: 12px; font-size: 16px; font-weight: 700;
  width: 100%;
}
.btn-primary:hover { background: #6d28d9; transform: translateY(-1px); }
.btn-primary:disabled { opacity: .4; cursor: not-allowed; transform: none; }
.btn-secondary {
  background: var(--bg3); color: var(--text);
  padding: 12px 24px; border-radius: 10px;
  font-size: 14px; font-weight: 500;
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--border); }

/* â”€â”€â”€ í—¤ë” â”€â”€â”€ */
header {
  padding: 20px 0; text-align: center;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100;
  background: rgba(10,10,15,0.9); backdrop-filter: blur(10px);
}
header h1 {
  font-size: 24px; font-weight: 900;
  letter-spacing: 8px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header-sub { font-size: 11px; color: var(--text2); margin-top: 4px; letter-spacing: 2px; }
.back-btn {
  position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
  background: none; color: var(--text2); font-size: 20px;
}
.back-btn:hover { color: var(--text); }

/* â”€â”€â”€ í™ˆ â”€â”€â”€ */
#home { padding-bottom: 60px; }
.hero {
  text-align: center; padding: 60px 0 40px;
}
.hero h2 {
  font-size: 28px; font-weight: 900; line-height: 1.4;
  margin-bottom: 12px;
}
.hero p { color: var(--text2); font-size: 14px; line-height: 1.6; }
.stats-bar {
  display: flex; justify-content: center; gap: 30px;
  padding: 20px 0; margin: 20px 0;
  border-top: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
}
.stat { text-align: center; }
.stat-val { font-size: 24px; font-weight: 900; color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text2); margin-top: 2px; }

.section-title {
  font-size: 18px; font-weight: 700; margin: 30px 0 16px;
  display: flex; align-items: center; gap: 8px;
}

/* â”€â”€â”€ ë°© ì¹´ë“œ â”€â”€â”€ */
.room-grid { display: flex; flex-direction: column; gap: 16px; }
.room-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px;
  cursor: pointer; transition: all .3s;
  position: relative; overflow: hidden;
}
.room-card:hover {
  border-color: var(--accent);
  box-shadow: 0 0 30px var(--accent-glow);
  transform: translateY(-2px);
}
.room-card.locked { opacity: .5; cursor: not-allowed; }
.room-card.cleared { border-color: var(--success); }
.room-emoji { font-size: 36px; margin-bottom: 12px; }
.room-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.room-desc { font-size: 13px; color: var(--text2); line-height: 1.5; margin-bottom: 12px; }
.room-meta {
  display: flex; gap: 12px; font-size: 12px; color: var(--text2);
}
.room-meta span { display: flex; align-items: center; gap: 4px; }
.room-badge {
  position: absolute; top: 16px; right: 16px;
  font-size: 11px; padding: 4px 10px; border-radius: 20px;
  font-weight: 700;
}
.badge-new { background: var(--accent); color: #fff; }
.badge-cleared { background: var(--success); color: #fff; }
.badge-locked { background: var(--border); color: var(--text2); }

/* â”€â”€â”€ ê²Œì„ í™”ë©´ â”€â”€â”€ */
#game { min-height: 100vh; padding-bottom: 40px; }
.game-header {
  text-align: center; padding: 20px 0;
}
.game-room-name { font-size: 14px; color: var(--accent); font-weight: 700; letter-spacing: 2px; }
.game-progress {
  display: flex; gap: 6px; justify-content: center; margin: 16px 0;
}
.prog-dot {
  width: 40px; height: 4px; border-radius: 2px;
  background: var(--border); transition: all .3s;
}
.prog-dot.active { background: var(--accent); }
.prog-dot.done { background: var(--success); }

.story-box {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px; margin: 20px 0;
  line-height: 1.8; font-size: 15px;
}
.story-box .narrator {
  color: var(--text2); font-style: italic; font-size: 13px;
  margin-bottom: 12px; display: block;
}

.puzzle-box {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px; margin: 20px 0;
}
.puzzle-title {
  font-size: 14px; font-weight: 700; color: var(--accent2);
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.puzzle-question {
  font-size: 15px; line-height: 1.7; margin-bottom: 20px;
}
.puzzle-hint {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px; margin-bottom: 16px;
  font-size: 13px; color: var(--warn);
}
.puzzle-hint::before { content: 'ğŸ’¡ '; }

/* CPQ ë¯¸ì…˜ ìŠ¤íƒ€ì¼ */
.cpq-mission {
  background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(6,182,212,0.1));
  border: 1px solid rgba(124,58,237,0.3);
  border-radius: 12px; padding: 16px; margin: 12px 0;
}
.cpq-keyword {
  display: inline-block; background: var(--accent);
  color: #fff; padding: 6px 14px; border-radius: 8px;
  font-size: 14px; font-weight: 700; cursor: pointer;
  margin: 8px 0;
}
.cpq-keyword:hover { background: #6d28d9; }
.cpq-steps {
  font-size: 13px; color: var(--text2); line-height: 1.8;
  margin: 12px 0;
}
.cpq-steps li { margin: 4px 0; }

.answer-input {
  display: flex; gap: 10px; margin-top: 16px;
}
.answer-input input {
  flex: 1; background: var(--bg);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 14px 16px; color: var(--text);
  font-size: 16px; font-family: inherit;
  outline: none; transition: border-color .2s;
}
.answer-input input:focus { border-color: var(--accent); }
.answer-input button {
  background: var(--accent); color: #fff;
  padding: 14px 24px; border-radius: 10px;
  font-size: 14px; font-weight: 700;
  white-space: nowrap;
}

.feedback {
  margin-top: 12px; padding: 12px 16px;
  border-radius: 10px; font-size: 14px; font-weight: 500;
}
.feedback.correct { background: rgba(34,197,94,0.15); color: var(--success); }
.feedback.wrong { background: rgba(239,68,68,0.15); color: var(--danger); }

/* â”€â”€â”€ ê²°ê³¼ í™”ë©´ â”€â”€â”€ */
#result { min-height: 100vh; display: flex; align-items: center; }
.result-card {
  text-align: center; width: 100%; padding: 40px 0;
}
.result-emoji { font-size: 64px; margin-bottom: 20px; }
.result-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; }
.result-sub { color: var(--text2); font-size: 14px; margin-bottom: 30px; }
.result-stats {
  display: flex; justify-content: center; gap: 24px; margin: 24px 0;
}
.result-stat {
  background: var(--card); border-radius: 12px; padding: 16px 24px;
  min-width: 80px;
}
.result-stat-val { font-size: 22px; font-weight: 900; color: var(--accent); }
.result-stat-label { font-size: 11px; color: var(--text2); margin-top: 4px; }
.grade-badge {
  display: inline-block;
  font-size: 20px; font-weight: 900;
  padding: 8px 24px; border-radius: 30px; margin: 16px 0;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #fff;
}
.result-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }

/* â”€â”€â”€ ë¡œë”© â”€â”€â”€ */
.loading {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 60px 0; gap: 16px;
}
.spinner {
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--text2); font-size: 14px; }

/* â”€â”€â”€ ë°˜ì‘í˜• â”€â”€â”€ */
@media (max-width: 400px) {
  .hero h2 { font-size: 22px; }
  .room-card { padding: 20px; }
}
</style>
</head>
<body>

<header>
  <button class="back-btn hidden" id="backBtn" onclick="goHome()">â†</button>
  <h1>QUBE</h1>
  <div class="header-sub">ESCAPE THE MYSTERY</div>
</header>

<!-- â”€â”€â”€ í™ˆ â”€â”€â”€ -->
<div id="home" class="container">
  <div class="hero">
    <h2>ë‹¹ì‹ ì€<br>íƒˆì¶œí•  ìˆ˜ ìˆëŠ”ê°€?</h2>
    <p>ë§¤ì¼ ìƒˆë¡œìš´ ë¯¸ìŠ¤í„°ë¦¬.<br>í’€ê³ , íƒˆì¶œí•˜ê³ , ì¦ëª…í•˜ë¼.</p>
  </div>
  <div class="stats-bar">
    <div class="stat">
      <div class="stat-val" id="statCleared">0</div>
      <div class="stat-label">í´ë¦¬ì–´</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="statGrade">ğŸ”°</div>
      <div class="stat-label">ë“±ê¸‰</div>
    </div>
    <div class="stat">
      <div class="stat-val" id="statStreak">0</div>
      <div class="stat-label">ì—°ì†</div>
    </div>
  </div>
  <div class="section-title">ğŸšª ë¯¸ìŠ¤í„°ë¦¬ ëª©ë¡</div>
  <div class="room-grid" id="roomGrid"></div>
</div>

<!-- â”€â”€â”€ ê²Œì„ â”€â”€â”€ -->
<div id="game" class="container hidden">
  <div class="game-header">
    <div class="game-room-name" id="gameRoomName"></div>
    <div class="game-progress" id="gameProgress"></div>
  </div>
  <div id="gameContent"></div>
</div>

<!-- â”€â”€â”€ ê²°ê³¼ â”€â”€â”€ -->
<div id="result" class="container hidden">
  <div class="result-card" id="resultContent"></div>
</div>

<script>
const API = 'https://qube-api.harpy922.workers.dev';

// â”€â”€â”€ ë°© í…œí”Œë¦¿ â”€â”€â”€
const ROOMS = [
  {
    id: 'professor',
    emoji: 'ğŸšï¸',
    name: 'ì‚¬ë¼ì§„ êµìˆ˜ì˜ ì„œì¬',
    desc: 'ëŒ€í•™ êµìˆ˜ê°€ ê°‘ìê¸° ì‹¤ì¢…ëë‹¤. ê·¸ì˜ ì„œì¬ì— ë“¤ì–´ì™”ì§€ë§Œ ë¬¸ì´ ì ê²¼ë‹¤. ë‚¨ì€ ë‹¨ì„œë¥¼ ëª¨ì•„ íƒˆì¶œí•˜ë¼.',
    difficulty: 1,
    time: '10ë¶„',
    intro: 'ìœ ëª… ê³ ê³ í•™ êµìˆ˜ ê¹€ë™í˜„ì´ 3ì¼ì§¸ ì—°ë½ì´ ì—†ë‹¤. ì¡°êµì¸ ë‹¹ì‹ ì€ ê·¸ì˜ ì„œì¬ì— ë“¤ì–´ì™”ë‹¤. ë¬¸ì´ ì² ì»¹ ì†Œë¦¬ì™€ í•¨ê»˜ ì ê²¼ë‹¤. ì±…ì¥ ì‚¬ì´, ì„œë ì†, ë²½ì— ê±¸ë¦° ê·¸ë¦¼ ë’¤ì— ë¬´ì–¸ê°€ ìˆì„ ê²ƒì´ë‹¤.',
    puzzles: [
      {
        type: 'general',
        title: 'ğŸ“‹ í¼ì¦ 1: ì±…ìƒ ìœ„ì˜ ë©”ëª¨',
        story: 'ì±…ìƒ ìœ„ì— êµìˆ˜ì˜ ë©”ëª¨ê°€ ìˆë‹¤. ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ìê°€ ì í˜€ìˆë‹¤.',
        question: 'ë‹¤ìŒ ì•”í˜¸ë¥¼ í•´ë…í•˜ë¼:\n\n<b>ã…ã„±ã…‡ ã……ã…ˆ ã…‚ã… = ?</b>\n\níŒíŠ¸: ê° ê¸€ìì˜ ì´ˆì„±ì´ë‹¤. "í•œêµ­ì˜ ìˆ˜ë„ ì„œìš¸"ì²˜ëŸ¼ ì½ì–´ë³´ë¼.',
        answer: 'í•œê¸€ì˜ ì‹œì‘ ë°”í',
        hint: 'ì´ˆì„±ë§Œ ë³´ë©´... ã…ã„±ã…‡ = í•œê¸€ì˜, ã……ã…ˆ = ì‹œì‘, ã…‚ã… = ?',
        validate: (input) => input.replace(/\s/g,'').includes('ë°”í')
      },
      { type: 'cpq', cpqIndex: 0,
        story: 'ì„œëì„ ì—´ì íƒë°° ì˜ìˆ˜ì¦ì´ ë‚˜ì™”ë‹¤. êµìˆ˜ê°€ ì‹¤ì¢… ì „ ë§ˆì§€ë§‰ìœ¼ë¡œ ê²€ìƒ‰í•œ ê²ƒ ê°™ë‹¤. ì´ ì¥ì†Œì˜ ë¹„ë°€ì„ í’€ì–´ì•¼ í•œë‹¤.',
        storyAfter: 'ì˜ìˆ˜ì¦ ë’·ë©´ì— ì íŒ ìˆ«ì... ì´ê²ƒì€ ì–´ë”˜ê°€ì˜ ê±¸ìŒ ìˆ˜ë‹¤. êµìˆ˜ëŠ” ì´ ì¥ì†Œë¥¼ ê°€ë ¤ í–ˆë˜ ê²ƒì´ë‹¤.' },
      {
        type: 'general',
        title: 'ğŸ”¢ í¼ì¦ 3: ê¸ˆê³  ë²ˆí˜¸',
        story: 'ë²½ ê·¸ë¦¼ ë’¤ì— ê¸ˆê³ ê°€ ìˆë‹¤. ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì•¼ í•œë‹¤.',
        question: 'êµìˆ˜ì˜ ì¼ê¸°ì— ì íŒ ìˆ˜ì—´:\n\n<b>2, 3, 5, 8, 13, ?</b>\n\në¹ˆì¹¸ì— ë“¤ì–´ê°ˆ ìˆ«ì ë‘ ê°œë¥¼ ì´ì–´ ì“°ì‹œì˜¤.\n(ì˜ˆ: ë‹¤ìŒ ë‘ ìˆ˜ê°€ 20, 33ì´ë©´ "2033")',
        answer: '2134',
        hint: 'í”¼ë³´ë‚˜ì¹˜ì™€ ë¹„ìŠ·í•˜ë‹¤. ê° ìˆ˜ëŠ” ì•ì˜ ë‘ ìˆ˜ì˜ í•©ì´ë‹¤.',
        validate: (input) => input.replace(/\s/g,'') === '2134'
      },
      { type: 'cpq', cpqIndex: 1,
        story: 'ê¸ˆê³  ì•ˆì— êµìˆ˜ì˜ ë¹„ë°€ ìˆ˜ì²©ì´ ìˆë‹¤. ë§ˆì§€ë§‰ í˜ì´ì§€ì— ë˜ ë‹¤ë¥¸ ì¥ì†Œê°€ ì í˜€ìˆë‹¤. êµìˆ˜ì˜ í–‰ë°©ì„ ì¶”ì í•˜ë ¤ë©´ ì´ê³³ë„ í™•ì¸í•´ì•¼ í•œë‹¤.',
        storyAfter: 'ìˆ˜ì²©ì˜ ë§ˆì§€ë§‰ ì¥ì— ì íŒ ìˆ«ìë¥¼ í™•ì¸í–ˆë‹¤. êµìˆ˜ì˜ ë™ì„ ì´ ì ì  ë“œëŸ¬ë‚œë‹¤.' },
      {
        type: 'general',
        title: 'ğŸšª í¼ì¦ 5: ìµœì¢… íƒˆì¶œ',
        story: 'ëª¨ë“  ë‹¨ì„œë¥¼ ëª¨ì•˜ë‹¤. ë¬¸ ì˜† íŒ¨ë„ì— ìµœì¢… ì½”ë“œë¥¼ ì…ë ¥í•´ì•¼ í•œë‹¤.',
        question: 'ì„œì¬ ê³³ê³³ì—ì„œ ë°œê²¬í•œ ì•ŒíŒŒë²³:\n\nì±…ìƒ: <b>E</b>, ì„œë: <b>S</b>, ê¸ˆê³ : <b>C</b>, ìˆ˜ì²©: <b>A</b>, ê·¸ë¦¼: <b>P</b>, ë¬¸: <b>E</b>\n\nì´ ê¸€ìë¥¼ ì˜¬ë°”ë¥¸ ìˆœì„œë¡œ ë°°ì—´í•˜ë©´?\n(íŒíŠ¸: ë‹¹ì‹ ì´ í•´ì•¼ í•  ê²ƒ)',
        answer: 'ESCAPE',
        hint: 'íƒˆì¶œ... ì˜ì–´ë¡œ?',
        validate: (input) => input.toUpperCase().replace(/\s/g,'') === 'ESCAPE'
      }
    ]
  },
  {
    id: 'ship',
    emoji: 'ğŸš¢',
    name: 'í‘œë¥˜ëœ í™”ë¬¼ì„ ',
    desc: 'í•´ì•ˆê°€ì— ë– ë°€ë ¤ ì˜¨ ë¬´ì¸ í™”ë¬¼ì„ . ì„ ì›ë“¤ì€ ì–´ë””ë¡œ ì‚¬ë¼ì¡ŒëŠ”ê°€? ë°°ì—ì„œ íƒˆì¶œí•˜ë¼.',
    difficulty: 2,
    time: '12ë¶„',
    intro: 'í•´ì•ˆê°€ì— ì •ì²´ë¶ˆëª…ì˜ í™”ë¬¼ì„ ì´ í‘œë¥˜í•´ì™”ë‹¤. í•´ì–‘ê²½ì°° ì†Œì†ì¸ ë‹¹ì‹ ì´ ì¡°ì‚¬ë¥¼ ì‹œì‘í–ˆì§€ë§Œ, ê°‘íŒ í•´ì¹˜ê°€ ë‹«íˆë©° ê°‡í˜”ë‹¤. ì„ ì› ê¸°ë¡ê³¼ í™”ë¬¼ ëª©ë¡ì—ì„œ ë‹¨ì„œë¥¼ ì°¾ì•„ë¼.',
    puzzles: [
      {
        type: 'general',
        title: 'ğŸ§­ í¼ì¦ 1: í•­í•´ ì¼ì§€',
        story: 'ì„ ì¥ì‹¤ í•­í•´ ì¼ì§€ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€. ì¢Œí‘œê°€ ì•”í˜¸ë¡œ ì í˜€ìˆë‹¤.',
        question: 'í•­í•´ ì¼ì§€ì— ì íŒ ì•”í˜¸:\n\n<b>A=1, B=2, C=3 ... ê·œì¹™ìœ¼ë¡œ</b>\n<b>8-5-12-16</b>\n\nì´ ìˆ«ìë“¤ì„ ì•ŒíŒŒë²³ìœ¼ë¡œ ë³€í™˜í•˜ë©´?',
        answer: 'HELP',
        hint: '8ë²ˆì§¸ ì•ŒíŒŒë²³ = H, 5ë²ˆì§¸ = E ...',
        validate: (input) => input.toUpperCase().replace(/\s/g,'') === 'HELP'
      },
      { type: 'cpq', cpqIndex: 0,
        story: 'í™”ë¬¼ì¹¸ì— ìˆ˜ìƒí•œ ë°°ì†¡ ê¸°ë¡ì´ ìˆë‹¤. ëˆ„êµ°ê°€ ì´ ì¥ì†Œë¥¼ ì¡°ì‚¬í•˜ê³  ìˆì—ˆë‹¤.',
        storyAfter: 'ë°°ì†¡ ê¸°ë¡ì˜ ê±¸ìŒ ìˆ˜ë¥¼ í™•ì¸í–ˆë‹¤. ì´ ì¥ì†Œì™€ ì‹¤ì¢…ëœ ì„ ì›ë“¤ ì‚¬ì´ì— ë¬´ìŠ¨ ì—°ê´€ì´ ìˆëŠ” ê±¸ê¹Œ.' },
      {
        type: 'general',
        title: 'âš“ í¼ì¦ 3: ëª¨ìŠ¤ ë¶€í˜¸',
        story: 'ë¬´ì „ê¸°ì—ì„œ ë°˜ë³µë˜ëŠ” ì‹ í˜¸ê°€ ë“¤ë¦°ë‹¤.',
        question: 'ëª¨ìŠ¤ ë¶€í˜¸ë¥¼ í•´ë…í•˜ë¼:\n\n<b>Â·Â·Â·  â”€â”€â”€ Â·Â·Â·</b>\n\nì´ê²ƒì€ êµ­ì œ ì¡°ë‚œ ì‹ í˜¸ë‹¤. ì„¸ ê¸€ìë¡œ ë‹µí•˜ë¼.',
        answer: 'SOS',
        hint: 'Â·Â·Â· = S, â”€â”€â”€ = O',
        validate: (input) => input.toUpperCase().replace(/\s/g,'') === 'SOS'
      },
      { type: 'cpq', cpqIndex: 1,
        story: 'ê¸°ê´€ì‹¤ì—ì„œ ì„ ì›ì˜ ê°œì¸ ë¬¼í’ˆì„ ë°œê²¬í–ˆë‹¤. ê·¸ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•œ ì¥ì†Œ ê¸°ë¡ì´ ë‚¨ì•„ìˆë‹¤.',
        storyAfter: 'ì„ ì›ì˜ ê¸°ë¡ê³¼ ì¼ì¹˜í•œë‹¤. ê·¸ë“¤ì´ ì™œ ì´ ì¥ì†Œë“¤ì„ ì¡°ì‚¬í–ˆëŠ”ì§€ ìœ¤ê³½ì´ ì¡íˆê¸° ì‹œì‘í•œë‹¤.' },
      {
        type: 'general',
        title: 'ğŸšª í¼ì¦ 5: í•´ì¹˜ í•´ì œ',
        story: 'ëª¨ë“  ë‹¨ì„œë¥¼ ì¡°í•©í•´ í•´ì¹˜ ì ê¸ˆì¥ì¹˜ë¥¼ í•´ì œí•´ì•¼ í•œë‹¤.',
        question: 'ì ê¸ˆì¥ì¹˜ì— ì íŒ ìˆ˜ìˆ˜ê»˜ë¼:\n\n"<b>ë‚˜ëŠ” ì•ìœ¼ë¡œ ê°€ë„ ë’¤ë¡œ ê°€ë„ ê°™ë‹¤.<br>ë°”ë‹¤ ìœ„ì—ì„œ íƒœì–´ë‚˜ ë°”ë‹¤ì—ì„œ ì£½ëŠ”ë‹¤.<br>ë‚˜ëŠ” ì„¸ ê¸€ìë‹¤.</b>"\n\nì •ë‹µì€?',
        answer: 'íŒŒë„',
        hint: 'ì•ë’¤ê°€ ê°™ì€ ê²ƒ... ë°”ë‹¤ì™€ ê´€ë ¨ëœ ê²ƒ...',
        validate: (input) => input.replace(/\s/g,'') === 'íŒŒë„'
      }
    ]
  },
  {
    id: 'hotel',
    emoji: 'ğŸ¨',
    name: 'í˜¸í…” ë¯¸ìŠ¤í„°ë¦¬',
    desc: 'ê³ ê¸‰ í˜¸í…” íˆ¬ìˆ™ê°ì´ ì‹¤ì¢…ëë‹¤. ê·¸ì˜ ë°©ì— ë‚¨ì€ í”ì ì„ ì«“ì•„ ì§„ì‹¤ì„ ë°í˜€ë¼.',
    difficulty: 3,
    time: '15ë¶„',
    intro: '5ì„±ê¸‰ í˜¸í…”ì˜ VIP íˆ¬ìˆ™ê° ë°•ì¤€í˜¸ ì”¨ê°€ ì²´í¬ì¸ í›„ ì‚¬ë¼ì¡Œë‹¤. ë³´ì•ˆíŒ€ì¸ ë‹¹ì‹ ì€ ê·¸ì˜ ë°© 1408í˜¸ì— ë“¤ì–´ì™”ë‹¤. ì¹´ë“œí‚¤ê°€ ì—ëŸ¬ë¥¼ ë‚´ë©° ë¬¸ì´ ì ê²¼ë‹¤. ë°© ì•ˆì˜ í”ì ì„ ëª¨ì•„ ìƒí™©ì„ íŒŒì•…í•˜ë¼.',
    puzzles: [
      {
        type: 'general',
        title: 'ğŸ”‘ í¼ì¦ 1: ì¹´ë“œí‚¤ í•´í‚¹',
        story: 'ì˜† í…Œì´ë¸”ì— íˆ¬ìˆ™ê°ì˜ ë…¸íŠ¸ë¶ì´ ì—´ë ¤ìˆë‹¤. ë¹„ë°€ë²ˆí˜¸ íŒíŠ¸ê°€ ì í˜€ìˆë‹¤.',
        question: 'ë…¸íŠ¸ë¶ í™”ë©´ì˜ ë¹„ë°€ë²ˆí˜¸ íŒíŠ¸:\n\n<b>"ë‚´ ë°© ë²ˆí˜¸ì—ì„œ ê°€ì¥ í° ìˆ˜ì™€ ê°€ì¥ ì‘ì€ ìˆ˜ì˜ ì°¨ì´"</b>\n\në°© ë²ˆí˜¸ëŠ” <b>1408</b>ì´ë‹¤. ì •ë‹µì€?',
        answer: '7',
        hint: '1408ì—ì„œ ê°€ì¥ í° ìˆ«ì = 8, ê°€ì¥ ì‘ì€ ìˆ«ì = 0. ì°¨ì´ëŠ”?',
        validate: (input) => input.trim() === '7'
      },
      { type: 'cpq', cpqIndex: 0,
        story: 'ë…¸íŠ¸ë¶ì— íˆ¬ìˆ™ê°ì˜ ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡ì´ ë‚¨ì•„ìˆë‹¤. ì‹¤ì¢… ì§ì „ ì´ ì¥ì†Œë¥¼ í™•ì¸í•œ ê²ƒ ê°™ë‹¤.',
        storyAfter: 'ê²€ìƒ‰ ê¸°ë¡ì˜ ì¥ì†Œì™€ ê±¸ìŒ ìˆ˜... íˆ¬ìˆ™ê°ì€ ì´ê³³ì„ ë°©ë¬¸í•˜ë ¤ í–ˆë˜ ê²ƒì´ë‹¤.' },
      {
        type: 'general',
        title: 'ğŸª í¼ì¦ 3: ê±°ìš¸ ì† ë©”ì‹œì§€',
        story: 'ìš•ì‹¤ ê±°ìš¸ì— ê¹€ì´ ì„œë ¤ ê¸€ìê°€ ë“œëŸ¬ë‚œë‹¤.',
        question: 'ê±°ìš¸ì— ë¹„ì¹œ ê¸€ì (ì¢Œìš°ë°˜ì „):\n\n<b>ë„ ì›€ ì„ ì²­ í•˜ ë¼</b>\n\nì´ ë¬¸ì¥ì„ ê±°ê¾¸ë¡œ ì½ìœ¼ë©´?',
        answer: 'ë¼í•˜ì²­ì„ì›€ë„',
        hint: 'í•œêµ­ì–´ë¥¼ ê±°ê¾¸ë¡œ... "ë„ì›€ì„ì²­í•˜ë¼" â†’ "ë¼í•˜ì²­ì„ì›€ë„"',
        validate: (input) => input.replace(/\s/g,'') === 'ë¼í•˜ì²­ì„ì›€ë„'
      },
      { type: 'cpq', cpqIndex: 1,
        story: 'ê¸ˆê³  ì•ˆì— íˆ¬ìˆ™ê°ì˜ ì¼ì •í‘œê°€ ìˆë‹¤. ë°©ë¬¸ ì˜ˆì •ì´ì—ˆë˜ ë˜ ë‹¤ë¥¸ ì¥ì†Œê°€ ê¸°ë¡ë¼ ìˆë‹¤.',
        storyAfter: 'ë‘ ì¥ì†Œì˜ ì—°ê²°ê³ ë¦¬ë¥¼ ì°¾ì•˜ë‹¤. íˆ¬ìˆ™ê°ì˜ ëª©ì ì´ ì ì  ì„ ëª…í•´ì§„ë‹¤.' },
      {
        type: 'general',
        title: 'ğŸšª í¼ì¦ 5: ë¹„ë°€ í†µë¡œ',
        story: 'ëª¨ë“  ë‹¨ì„œê°€ í•˜ë‚˜ë¡œ ëª¨ì˜€ë‹¤. ë²½ ì† ë¹„ë°€ í†µë¡œì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë¼.',
        question: 'íˆ¬ìˆ™ê°ì´ ë‚¨ê¸´ ë§ˆì§€ë§‰ ë©”ëª¨:\n\n<b>"ì²´í¬ì¸: 14ì‹œ, ì²´í¬ì•„ì›ƒ: 08ì‹œ<br>ë°©: 1408í˜¸, ì¸µ: 14ì¸µ<br>ë¹„ë°€ë²ˆí˜¸ = ëª¨ë“  ìˆ«ìì˜ í•©"</b>\n\n14 + 8 + 1408 + 14 = ?',
        answer: '1444',
        hint: '14 + 8 + 1408 + 14 ë¥¼ ê³„ì‚°í•´ë³´ì',
        validate: (input) => input.trim() === '1444'
      }
    ]
  }
];

// â”€â”€â”€ ê²Œì„ ìƒíƒœ â”€â”€â”€
let state = {
  currentRoom: null,
  currentPuzzle: 0,
  cpqCampaigns: [],
  startTime: null,
  attempts: 0,
};

function loadProgress() {
  try { return JSON.parse(localStorage.getItem('qube_progress') || '{}'); }
  catch { return {}; }
}
function saveProgress(p) { localStorage.setItem('qube_progress', JSON.stringify(p)); }

function getGrade(cleared) {
  if (cleared >= 10) return 'ğŸ•µï¸ ì…œë¡';
  if (cleared >= 7) return 'ğŸ” ëª…íƒì •';
  if (cleared >= 4) return 'ğŸ§ íƒì •';
  if (cleared >= 2) return 'ğŸ“‹ ìˆ˜ìŠµíƒì •';
  return 'ğŸ”° ì´ˆë³´íƒì •';
}

// â”€â”€â”€ í™”ë©´ ì „í™˜ â”€â”€â”€
function showScreen(id) {
  ['home','game','result'].forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
  document.getElementById('backBtn').classList.toggle('hidden', id === 'home');
  window.scrollTo(0, 0);
}

function goHome() {
  state.currentRoom = null;
  showScreen('home');
  renderHome();
}

// â”€â”€â”€ í™ˆ ë Œë”ë§ â”€â”€â”€
function renderHome() {
  const progress = loadProgress();
  const cleared = Object.keys(progress).filter(k => progress[k]?.cleared).length;

  document.getElementById('statCleared').textContent = cleared;
  document.getElementById('statGrade').textContent = getGrade(cleared).split(' ')[0];

  const grid = document.getElementById('roomGrid');
  grid.innerHTML = ROOMS.map(room => {
    const p = progress[room.id];
    const isClear = p?.cleared;
    const stars = 'â­'.repeat(room.difficulty) + 'â˜†'.repeat(3 - room.difficulty);
    const badge = isClear
      ? '<span class="room-badge badge-cleared">âœ“ í´ë¦¬ì–´</span>'
      : '<span class="room-badge badge-new">NEW</span>';

    return `
      <div class="room-card ${isClear ? 'cleared' : ''}" onclick="startRoom('${room.id}')">
        ${badge}
        <div class="room-emoji">${room.emoji}</div>
        <div class="room-name">${room.name}</div>
        <div class="room-desc">${room.desc}</div>
        <div class="room-meta">
          <span>${stars}</span>
          <span>â± ${room.time}</span>
          ${isClear ? `<span>ğŸ† ${formatTime(p.bestTime)}</span>` : ''}
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€ ê²Œì„ ì‹œì‘ â”€â”€â”€
async function startRoom(roomId) {
  const room = ROOMS.find(r => r.id === roomId);
  if (!room) return;

  state.currentRoom = room;
  state.currentPuzzle = 0;
  state.startTime = Date.now();
  state.attempts = 0;

  showScreen('game');
  document.getElementById('gameRoomName').textContent = room.name;

  // CPQ ìº í˜ì¸ ë¡œë”©
  document.getElementById('gameContent').innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <div class="loading-text">ë°©ì— ì§„ì…í•˜ëŠ” ì¤‘...</div>
    </div>`;

  try {
    const cpqCount = room.puzzles.filter(p => p.type === 'cpq').length;
    const res = await fetch(`${API}/api/random?count=${cpqCount}`);
    const data = await res.json();
    state.cpqCampaigns = data.campaigns || [];
  } catch(e) {
    state.cpqCampaigns = [];
  }

  // ì¸íŠ¸ë¡œ
  renderIntro();
}

function renderIntro() {
  const room = state.currentRoom;
  renderProgress();
  document.getElementById('gameContent').innerHTML = `
    <div class="story-box">
      <span class="narrator">ğŸ“– í”„ë¡¤ë¡œê·¸</span>
      ${room.intro}
    </div>
    <button class="btn-primary" onclick="renderPuzzle(0)">ì¡°ì‚¬ ì‹œì‘ â†’</button>`;
}

function renderProgress() {
  const room = state.currentRoom;
  const total = room.puzzles.length;
  document.getElementById('gameProgress').innerHTML =
    Array.from({length: total}, (_, i) => {
      const cls = i < state.currentPuzzle ? 'done' : i === state.currentPuzzle ? 'active' : '';
      return `<div class="prog-dot ${cls}"></div>`;
    }).join('');
}

// â”€â”€â”€ í¼ì¦ ë Œë”ë§ â”€â”€â”€
function renderPuzzle(idx) {
  state.currentPuzzle = idx;
  renderProgress();

  const room = state.currentRoom;
  const puzzle = room.puzzles[idx];

  if (puzzle.type === 'cpq') {
    renderCpqPuzzle(idx, puzzle);
  } else {
    renderGeneralPuzzle(idx, puzzle);
  }
}

function renderGeneralPuzzle(idx, puzzle) {
  const total = state.currentRoom.puzzles.length;
  document.getElementById('gameContent').innerHTML = `
    <div class="story-box">
      <span class="narrator">ğŸ“– ìƒí™©</span>
      ${puzzle.story}
    </div>
    <div class="puzzle-box">
      <div class="puzzle-title">${puzzle.title}</div>
      <div class="puzzle-question">${puzzle.question}</div>
      <div class="puzzle-hint hidden" id="hintBox">${puzzle.hint}</div>
      <button class="btn-secondary" onclick="document.getElementById('hintBox').classList.remove('hidden')" style="margin-bottom:12px;font-size:13px;">ğŸ’¡ íŒíŠ¸ ë³´ê¸°</button>
      <div class="answer-input">
        <input type="text" id="answerInput" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" onkeydown="if(event.key==='Enter')checkGeneral(${idx})">
        <button onclick="checkGeneral(${idx})">í™•ì¸</button>
      </div>
      <div id="feedback"></div>
    </div>`;
  document.getElementById('answerInput').focus();
}

function renderCpqPuzzle(idx, puzzle) {
  const cpqCamp = state.cpqCampaigns[puzzle.cpqIndex];
  if (!cpqCamp) {
    // CPQ ìº í˜ì¸ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    nextPuzzle(idx);
    return;
  }

  // joindescì—ì„œ íŒíŠ¸ íŒŒì‹±
  const desc = cpqCamp.join_desc || '';
  const keyword = cpqCamp.search_keyword || '';

  // ë§ˆìŠ¤í‚¹ëœ ê°€ê²Œ ì´ë¦„ ì¶”ì¶œ
  const placeMatch = desc.match(/\[([^\]]*X[^\]]*)\]/);
  const placeHint = placeMatch ? placeMatch[1] : '???';

  // ì¶œë°œì§€ ì¶”ì¶œ
  const startMatch = desc.match(/ì¶œë°œì§€ë¥¼\s*\[([^\]]+)\]/);
  const startPlace = startMatch ? startMatch[1] : 'ì§€ì •ëœ ì¶œë°œì§€';

  document.getElementById('gameContent').innerHTML = `
    <div class="story-box">
      <span class="narrator">ğŸ“– ìƒí™©</span>
      ${puzzle.story}
    </div>
    <div class="puzzle-box">
      <div class="puzzle-title">ğŸ” í¼ì¦ ${idx + 1}: ì¥ì†Œ ì¶”ì  ë¯¸ì…˜</div>
      <div class="puzzle-question">
        ë‹¨ì„œì— ì íŒ ì¥ì†Œë¥¼ ì°¾ì•„ì•¼ í•œë‹¤. ë„¤ì´ë²„ì—ì„œ ê²€ìƒ‰í•˜ì—¬ ê±¸ìŒ ìˆ˜ë¥¼ í™•ì¸í•˜ë¼.
      </div>
      <div class="cpq-mission">
        <div style="font-size:13px;color:var(--text2);margin-bottom:8px;">ğŸ“‹ ë¯¸ì…˜ ìˆœì„œ</div>
        <ol class="cpq-steps">
          <li>ì•„ë˜ í‚¤ì›Œë“œë¥¼ ë³µì‚¬í•˜ì—¬ <b>ë„¤ì´ë²„</b>ì—ì„œ ê²€ìƒ‰</li>
          <li>ê²€ìƒ‰ ê²°ê³¼ì—ì„œ <b>${placeHint}</b> í´ë¦­</li>
          <li>í”Œë ˆì´ìŠ¤ì—ì„œ <b>ì§€ë„</b> íƒ­ â†’ <b>ì§€ë„ì•±ìœ¼ë¡œ ë³´ê¸°</b></li>
          <li><b>ë„ì°©</b> ë²„íŠ¼ í´ë¦­</li>
          <li>ì¶œë°œì§€ë¥¼ <b>${startPlace}</b>ë¡œ ì„¤ì •</li>
          <li><b>ë„ë³´</b> â†’ <b>ê°€ì¥ ë¹ ë¥¸</b> ê²½ë¡œì˜ ê±¸ìŒ ìˆ˜ í™•ì¸</li>
        </ol>
        <div style="margin-top:12px;">
          <span style="font-size:12px;color:var(--text2);">ê²€ìƒ‰ í‚¤ì›Œë“œ:</span><br>
          <span class="cpq-keyword" onclick="copyKeyword(this)" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">${keyword} ğŸ“‹</span>
        </div>
      </div>
      <div class="answer-input">
        <input type="number" id="answerInput" placeholder="ê±¸ìŒ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeydown="if(event.key==='Enter')checkCpq(${idx})">
        <button onclick="checkCpq(${idx})">í™•ì¸</button>
      </div>
      <div id="feedback"></div>
    </div>`;
  document.getElementById('answerInput').focus();
}

// â”€â”€â”€ ê²€ì¦ â”€â”€â”€
function checkGeneral(idx) {
  const input = document.getElementById('answerInput').value.trim();
  if (!input) return;

  state.attempts++;
  const puzzle = state.currentRoom.puzzles[idx];
  const correct = puzzle.validate(input);
  showFeedback(correct, idx);
}

async function checkCpq(idx) {
  const input = document.getElementById('answerInput').value.trim();
  if (!input) return;

  state.attempts++;
  const puzzle = state.currentRoom.puzzles[idx];
  const cpqCamp = state.cpqCampaigns[puzzle.cpqIndex];

  try {
    const res = await fetch(`${API}/api/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ campaign_id: cpqCamp.id, user_answer: input })
    });
    const data = await res.json();
    showFeedback(data.correct, idx);
  } catch(e) {
    showFeedback(false, idx);
  }
}

function showFeedback(correct, idx) {
  const fb = document.getElementById('feedback');
  if (correct) {
    const puzzle = state.currentRoom.puzzles[idx];
    const afterText = puzzle.storyAfter || '';
    fb.innerHTML = `
      <div class="feedback correct">
        âœ… ì •ë‹µ! ${afterText ? '<br><br>' + afterText : ''}
      </div>
      <button class="btn-primary" style="margin-top:16px;" onclick="nextPuzzle(${idx})">
        ${idx < state.currentRoom.puzzles.length - 1 ? 'ë‹¤ìŒ í¼ì¦ â†’' : 'ğŸšª íƒˆì¶œ!'}
      </button>`;
  } else {
    fb.innerHTML = `<div class="feedback wrong">âŒ ì˜¤ë‹µ. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.</div>`;
    document.getElementById('answerInput').value = '';
    document.getElementById('answerInput').focus();
  }
}

function nextPuzzle(currentIdx) {
  const next = currentIdx + 1;
  if (next >= state.currentRoom.puzzles.length) {
    showResult();
  } else {
    renderPuzzle(next);
  }
}

// â”€â”€â”€ ê²°ê³¼ â”€â”€â”€
function showResult() {
  const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
  const room = state.currentRoom;

  // ì €ì¥
  const progress = loadProgress();
  const prev = progress[room.id];
  const bestTime = prev?.bestTime ? Math.min(prev.bestTime, elapsed) : elapsed;
  progress[room.id] = { cleared: true, bestTime, lastPlayed: Date.now() };
  saveProgress(progress);

  const cleared = Object.keys(progress).filter(k => progress[k]?.cleared).length;
  const grade = getGrade(cleared);

  // ë“±ê¸‰
  let gameGrade = 'S';
  if (elapsed > 600) gameGrade = 'C';
  else if (elapsed > 300) gameGrade = 'B';
  else if (elapsed > 180) gameGrade = 'A';

  showScreen('result');
  document.getElementById('resultContent').innerHTML = `
    <div class="result-emoji">ğŸ‰</div>
    <div class="result-title">íƒˆì¶œ ì„±ê³µ!</div>
    <div class="result-sub">${room.name}ì—ì„œ ë¬´ì‚¬íˆ íƒˆì¶œí–ˆìŠµë‹ˆë‹¤</div>
    <div class="grade-badge">${gameGrade} RANK</div>
    <div class="result-stats">
      <div class="result-stat">
        <div class="result-stat-val">${formatTime(elapsed)}</div>
        <div class="result-stat-label">ì†Œìš”ì‹œê°„</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-val">${state.attempts}</div>
        <div class="result-stat-label">ì‹œë„íšŸìˆ˜</div>
      </div>
      <div class="result-stat">
        <div class="result-stat-val">${grade.split(' ')[0]}</div>
        <div class="result-stat-label">${grade.split(' ')[1]}</div>
      </div>
    </div>
    <div class="result-buttons">
      <button class="btn-primary" onclick="goHome()">ğŸšª ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
      <button class="btn-secondary" onclick="shareResult('${room.id}','${gameGrade}',${elapsed})">ğŸ“¤ ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
    </div>`;
}

// â”€â”€â”€ ìœ í‹¸ â”€â”€â”€
function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}

function copyKeyword(el) {
  const text = el.textContent.replace(' ğŸ“‹','').trim();
  navigator.clipboard?.writeText(text);
  el.textContent = text + ' âœ“';
  setTimeout(() => el.textContent = text + ' ğŸ“‹', 1500);
}

function shareResult(roomId, grade, time) {
  const room = ROOMS.find(r => r.id === roomId);
  const text = `ğŸ” QUBE - ${room.name}\n${room.emoji} ${grade} RANK | â± ${formatTime(time)}\n\në‚˜ëŠ” íƒˆì¶œí–ˆë‹¤. ë‹¹ì‹ ì€?\nğŸ‘‰ https://qube.salmonholic.com`;
  if (navigator.share) {
    navigator.share({ text });
  } else {
    navigator.clipboard?.writeText(text);
    alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
}

// â”€â”€â”€ ì´ˆê¸°í™” â”€â”€â”€
renderHome();
</script>
</body>
</html>
